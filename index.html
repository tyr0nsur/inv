<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Inventario Pro V10</title>
    <script src="https://cdn.jsdelivr.net/npm/@ericblade/quagga2/dist/quagga.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        :root { --primary: #007bff; --dark: #121212; }
        body { background-color: var(--dark); color: white; font-family: sans-serif; margin: 0; overflow-x: hidden; }
        
        /* Pantalla de Inicio (Necesaria para permisos) */
        #splash {
            position: fixed; top:0; left:0; width:100%; height:100%;
            background: var(--dark); z-index: 2000;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }

        /* Contenedor de CÃ¡mara */
        #camera-area {
            width: 100%; height: 40vh; background: #000;
            position: relative; border-bottom: 2px solid var(--primary);
        }
        #camera-area video, #camera-area canvas {
            width: 100%; height: 100%; object-fit: cover; position: absolute;
        }

        /* GuÃ­a Visual */
        .scanner-target {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 70%; height: 50%; border: 2px solid rgba(255,255,255,0.5);
            border-radius: 15px; z-index: 10; pointer-events: none;
        }

        /* Panel de Lista */
        .inventory-panel {
            background: white; color: #333; min-height: 60vh;
            border-radius: 25px 25px 0 0; margin-top: -25px;
            position: relative; z-index: 100; padding: 20px;
        }
        
        .item-card {
            background: #f8f9fa; border-radius: 12px; padding: 15px;
            margin-bottom: 10px; display: flex; justify-content: space-between;
            align-items: center; border-left: 5px solid var(--primary);
        }
    </style>
</head>
<body>

<div id="splash">
    <h2 class="mb-4 text-center">Gestor de Inventario</h2>
    <button class="btn btn-primary btn-lg px-5 shadow-lg" onclick="startApp()">ðŸš€ COMENZAR</button>
    <p class="mt-3 text-muted small">Haz clic para activar cÃ¡mara e inventario</p>
</div>

<div id="main-content" style="display:none;">
    <div id="camera-area">
        <div class="scanner-target"></div>
    </div>

    <div class="inventory-panel shadow-lg">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h4 class="fw-bold m-0">Productos</h4>
            <span id="counter" class="badge bg-primary rounded-pill">0</span>
        </div>
        <div id="inventory-list">
            </div>
    </div>
</div>

<div class="modal fade" id="actionModal" data-bs-backdrop="static" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered px-3">
        <div class="modal-content text-dark" style="border-radius: 20px;">
            <div class="modal-body p-4">
                <div id="new-item-form">
                    <h5 class="fw-bold text-primary">Nuevo Producto</h5>
                    <input type="text" id="in-name" class="form-control mb-3" placeholder="Nombre (ej. Tornillos)">
                    <select id="in-unit" class="form-select mb-3">
                        <option value="Unid.">Unidades</option>
                        <option value="Kg">Kilos</option>
                    </select>
                </div>
                <div id="edit-item-info" class="text-center" style="display:none;">
                    <h2 id="txt-item-name" class="fw-bold"></h2>
                    <p id="txt-item-stock" class="text-muted"></p>
                </div>
                <div class="d-flex justify-content-center align-items-center gap-3 my-4">
                    <button class="btn btn-outline-secondary" onclick="step(-1)">-</button>
                    <input type="number" id="in-qty" class="form-control text-center fw-bold" style="width: 80px;" value="1">
                    <button class="btn btn-outline-secondary" onclick="step(1)">+</button>
                </div>
                <button class="btn btn-primary w-100 py-3 fw-bold" onclick="save()">GUARDAR CAMBIOS</button>
                <button class="btn btn-link w-100 text-muted mt-2" onclick="cancel()">Cerrar</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    let db = JSON.parse(localStorage.getItem('inventory_v10')) || {};
    let currentCode = null;
    let isProcessing = false;
    const modalUI = new bootstrap.Modal(document.getElementById('actionModal'));

    function startApp() {
        document.getElementById('splash').style.display = 'none';
        document.getElementById('main-content').style.display = 'block';
        initScanner();
        renderList();
    }

    function initScanner() {
        Quagga.init({
            inputStream: {
                name: "Live",
                type: "LiveStream",
                target: document.querySelector('#camera-area'),
                constraints: { facingMode: "environment" }
            },
            decoder: { readers: ["ean_reader", "code_128_reader", "upc_reader", "ean_8_reader"] },
            locate: true
        }, (err) => {
            if (err) {
                alert("Error de cÃ¡mara: AsegÃºrate de usar HTTPS y dar permisos.");
                return;
            }
            Quagga.start();
        });

        Quagga.onDetected((data) => {
            if (isProcessing) return;
            const code = data.codeResult.code;
            isProcessing = true;
            beep();
            if (navigator.vibrate) navigator.vibrate(100);
            
            Quagga.stop();
            showAction(code);
        });
    }

    function showAction(code) {
        currentCode = code;
        document.getElementById('in-qty').value = 1;
        
        if (db[code]) {
            document.getElementById('new-item-form').style.display = 'none';
            document.getElementById('edit-item-info').style.display = 'block';
            document.getElementById('txt-item-name').innerText = db[code].nombre;
            document.getElementById('txt-item-stock').innerText = `Stock: ${db[code].stock} ${db[code].unidad}`;
        } else {
            document.getElementById('new-item-form').style.display = 'block';
            document.getElementById('edit-item-info').style.display = 'none';
        }
        modalUI.show();
    }

    function save() {
        const qty = parseInt(document.getElementById('in-qty').value);
        if (db[currentCode]) {
            db[currentCode].stock += qty;
        } else {
            const name = document.getElementById('in-name').value;
            if(!name) return alert("Escribe un nombre");
            db[currentCode] = { nombre: name, unidad: document.getElementById('in-unit').value, stock: qty };
        }
        localStorage.setItem('inventory_v10', JSON.stringify(db));
        renderList();
        cancel();
    }

    function renderList() {
        const container = document.getElementById('inventory-list');
        const keys = Object.keys(db);
        document.getElementById('counter').innerText = keys.length;
        container.innerHTML = "";
        keys.reverse().forEach(code => {
            container.innerHTML += `
                <div class="item-card shadow-sm">
                    <div>
                        <div class="fw-bold">${db[code].nombre}</div>
                        <small class="text-muted">${code}</small>
                    </div>
                    <div class="text-primary fw-bold fs-5">${db[code].stock}</div>
                </div>`;
        });
    }

    function cancel() {
        modalUI.hide();
        isProcessing = false;
        currentCode = null;
        document.getElementById('in-name').value = "";
        setTimeout(() => initScanner(), 300);
    }

    function step(v) { document.getElementById('in-qty').value = parseInt(document.getElementById('in-qty').value) + v; }

    function beep() {
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const osc = ctx.createOscillator();
        const g = ctx.createGain();
        osc.connect(g); g.connect(ctx.destination);
        osc.frequency.value = 1000; g.gain.setValueAtTime(0.1, ctx.currentTime);
        osc.start(); g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime + 0.1);
        osc.stop(ctx.currentTime + 0.1);
    }
</script>
</body>
</html>
