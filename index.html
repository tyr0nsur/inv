<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Inventario Pro V3 - Hard Focus</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        body { background-color: #1a1a1a; color: white; }
        #reader { width: 100%; max-width: 600px; margin: auto; border: 3px solid #0d6efd; border-radius: 15px; overflow: hidden; }
        .controls { background: #2d2d2d; padding: 20px; border-radius: 15px 15px 0 0; margin-top: 10px; }
        /* L√≠nea gu√≠a para ayudar al usuario a centrar el c√≥digo */
        .guia-lectura {
            position: absolute;
            top: 50%; left: 10%; right: 10%;
            height: 2px; background: red;
            box-shadow: 0 0 8px red;
            z-index: 10;
            pointer-events: none;
        }
        .scanner-container { position: relative; }
    </style>
</head>
<body>

<div class="container py-3">
    <h3 class="text-center text-primary mb-3">üì¶ Esc√°ner de Precisi√≥n</h3>
    
    <div class="scanner-container">
        <div id="reader"></div>
        <div id="linea-roja" class="guia-lectura" style="display:none;"></div>
    </div>

    <div class="controls mt-3">
        <div class="d-grid gap-2">
            <button id="btn-start" class="btn btn-primary btn-lg" onclick="encenderCamara()">‚ö° INICIAR ESC√ÅNER</button>
            <button id="btn-stop" class="btn btn-outline-danger btn-sm" onclick="apagarCamara()" style="display:none;">Detener</button>
        </div>

        <div id="form-nuevo" class="mt-4 p-3 border border-primary rounded" style="display:none; background: #333;">
            <h5 class="text-info">C√≥digo: <span id="txt-codigo"></span></h5>
            <input type="text" id="nombre" class="form-control mb-2" placeholder="Nombre del producto">
            <select id="unidad" class="form-select mb-2">
                <option value="Unidad">Unidad</option>
                <option value="Litro">Litro</option>
                <option value="Caja">Caja</option>
            </select>
            <button class="btn btn-success w-100" onclick="guardar()">Guardar en Inventario</button>
        </div>
    </div>

    <div class="mt-4">
        <h6>√öltimos escaneados:</h6>
        <ul id="lista-recientes" class="list-group"></ul>
    </div>
</div>

<script>
    let html5QrCode;
    let inventario = JSON.parse(localStorage.getItem('inv_v3')) || {};

    function encenderCamara() {
        document.getElementById('btn-start').style.display = 'none';
        document.getElementById('btn-stop').style.display = 'block';
        document.getElementById('linea-roja').style.display = 'block';

        html5QrCode = new Html5Qrcode("reader");
        
        // CONFIGURACI√ìN CR√çTICA PARA C√ìDIGOS DE BARRAS
        const config = { 
            fps: 20, 
            qrbox: { width: 300, height: 150 }, // Caja estirada para c√≥digos de barras
            aspectRatio: 1.0,
            // Aqu√≠ forzamos a la librer√≠a a usar todos los decodificadores de barras conocidos
            formatsToSupport: [ 
                Html5QrcodeSupportedFormats.EAN_13, 
                Html5QrcodeSupportedFormats.EAN_8, 
                Html5QrcodeSupportedFormats.CODE_128, 
                Html5QrcodeSupportedFormats.UPC_A, 
                Html5QrcodeSupportedFormats.UPC_E 
            ]
        };

        html5QrCode.start({ facingMode: "environment" }, config, (text) => {
            vibrar();
            procesarDato(text);
        }).catch(err => alert("Error: " + err));
    }

    function procesarDato(codigo) {
        if (inventario[codigo]) {
            inventario[codigo].stock++;
            localStorage.setItem('inv_v3', JSON.stringify(inventario));
            alert(`Actualizado: ${inventario[codigo].nombre} (Stock: ${inventario[codigo].stock})`);
            actualizarLista();
        } else {
            // Detener para que el usuario pueda escribir
            apagarCamara();
            document.getElementById('txt-codigo').innerText = codigo;
            document.getElementById('form-nuevo').style.display = 'block';
        }
    }

    function guardar() {
        const codigo = document.getElementById('txt-codigo').innerText;
        const nombre = document.getElementById('nombre').value;
        const unidad = document.getElementById('unidad').value;

        if(!nombre) return alert("Escribe un nombre");

        inventario[codigo] = { nombre, unidad, stock: 1 };
        localStorage.setItem('inv_v3', JSON.stringify(inventario));
        
        document.getElementById('form-nuevo').style.display = 'none';
        document.getElementById('nombre').value = "";
        actualizarLista();
        encenderCamara(); // Reanudar
    }

    function apagarCamara() {
        if(html5QrCode) {
            html5QrCode.stop().then(() => {
                document.getElementById('btn-start').style.display = 'block';
                document.getElementById('btn-stop').style.display = 'none';
                document.getElementById('linea-roja').style.display = 'none';
            });
        }
    }

    function vibrar() {
        if (navigator.vibrate) navigator.vibrate(150);
    }

    function actualizarLista() {
        const out = document.getElementById('lista-recientes');
        out.innerHTML = "";
        const keys = Object.keys(inventario).reverse().slice(0, 5);
        keys.forEach(k => {
            const li = document.createElement('li');
            li.className = "list-group-item bg-dark text-white border-secondary";
            li.innerHTML = `<b>${inventario[k].nombre}</b> - ${inventario[k].stock} ${inventario[k].unidad}`;
            out.appendChild(li);
        });
    }

    actualizarLista();
</script>
</body>
</html>
