<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Inventario Pro V9 - QuaggaJS Optimized</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@ericblade/quagga2/dist/quagga.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <style>
        :root { --neon-green: #39ff14; --dark-bg: #1a1d21; }
        body { background-color: var(--dark-bg); color: #fff; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        
        /* Contenedor de C√°mara */
        #interactive.viewport {
            position: relative; width: 100%; height: 350px; background: #000;
            border-bottom: 3px solid var(--neon-green); overflow: hidden;
        }
        #interactive.viewport video, #interactive.viewport canvas {
            width: 100%; height: 100%; object-fit: cover; position: absolute; top: 0; left: 0;
        }
        
        /* Visor de Enfoque */
        .scanner-guide {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 70%; height: 40%; border: 2px dashed rgba(57, 255, 20, 0.5);
            z-index: 10; pointer-events: none; border-radius: 10px;
        }

        .panel-ui {
            background: #fff; color: #333; border-radius: 25px 25px 0 0;
            margin-top: -30px; position: relative; padding: 25px 15px; min-height: 60vh;
        }

        .btn-scan {
            background: var(--neon-green); color: #000; font-weight: bold;
            border: none; border-radius: 15px; padding: 15px; width: 100%;
            box-shadow: 0 4px 15px rgba(57, 255, 20, 0.3);
        }

        .inventory-card {
            background: #f8f9fa; border-radius: 12px; padding: 12px;
            margin-bottom: 10px; border-left: 5px solid #0d6efd;
        }
    </style>
</head>
<body>

<div id="interactive" class="viewport">
    <div class="scanner-guide"></div>
</div>

<div class="panel-ui shadow-lg">
    <div class="container">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h4 class="fw-bold m-0 text-dark">Almac√©n Inteligente</h4>
            <button class="btn btn-sm btn-outline-danger" onclick="exportarPDF()">PDF Report</button>
        </div>

        <button id="btn-toggle" class="btn btn-scan mb-4" onclick="toggleScanner()">
            üîå ACTIVAR ESC√ÅNER
        </button>

        <h6 class="text-muted text-uppercase mb-3" style="font-size: 0.75rem; letter-spacing: 1px;">Productos en Inventario</h6>
        <div id="lista-productos">
            </div>
    </div>
</div>

<div class="modal fade" id="modalProducto" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0">
            <div class="modal-header bg-dark text-white">
                <h5 class="modal-title" id="m-titulo">Gesti√≥n de Producto</h5>
            </div>
            <div class="modal-body p-4 text-dark">
                <div id="form-nuevo" style="display:none;">
                    <label class="small fw-bold">Nombre del Art√≠culo</label>
                    <input type="text" id="p-nombre" class="form-control mb-3" placeholder="Ej: Tornillos Acero">
                    <label class="small fw-bold">Unidad de Medida</label>
                    <select id="p-medida" class="form-select mb-3">
                        <option value="Unidades">Unidades</option>
                        <option value="Litros">Litros</option>
                        <option value="Cajas">Cajas</option>
                        <option value="Kg">Kilogramos</option>
                    </select>
                </div>
                <div id="info-existente" class="text-center mb-3">
                    <h3 id="txt-nombre" class="fw-bold"></h3>
                    <span id="txt-codigo" class="badge bg-secondary"></span>
                </div>
                <label class="d-block text-center small mb-2">Cantidad a registrar (Entrada/Salida)</label>
                <div class="input-group input-group-lg w-75 mx-auto">
                    <button class="btn btn-outline-secondary" onclick="ajustar(-1)">-</button>
                    <input type="number" id="p-cantidad" class="form-control text-center fw-bold" value="1">
                    <button class="btn btn-outline-secondary" onclick="ajustar(1)">+</button>
                </div>
            </div>
            <div class="modal-footer border-0">
                <button class="btn btn-light" onclick="cerrarModal()">Cancelar</button>
                <button class="btn btn-primary px-4" onclick="guardar()">CONFIRMAR</button>
            </div>
        </div>
    </div>
</div>

<script>
    let db = JSON.parse(localStorage.getItem('quagga_pro_db')) || {};
    let codActual = "";
    let escanerActivo = false;
    const modalUI = new bootstrap.Modal(document.getElementById('modalProducto'));

    // --- GENERADOR DE SONIDO (BEEP) ---
    function playPi() {
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.connect(gain); gain.connect(audioCtx.destination);
        osc.frequency.value = 1000; gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
        osc.start(); gain.gain.exponentialRampToValueAtTime(0.00001, audioCtx.currentTime + 0.1);
        osc.stop(audioCtx.currentTime + 0.1);
    }

    function toggleScanner() {
        if(escanerActivo) {
            Quagga.stop();
            escanerActivo = false;
            document.getElementById('btn-toggle').innerText = "üîå ACTIVAR ESC√ÅNER";
            document.getElementById('btn-toggle').style.background = "#39ff14";
        } else {
            iniciarQuagga();
        }
    }

    function iniciarQuagga() {
        Quagga.init({
            inputStream: {
                name: "Live", type: "LiveStream",
                target: document.querySelector('#interactive'),
                constraints: { facingMode: "environment", aspectRatio: {ideal: 1} }
            },
            locator: { patchSize: "medium", halfSample: true },
            decoder: { readers: ["ean_reader", "code_128_reader", "upc_reader", "ean_8_reader"] },
            locate: true
        }, (err) => {
            if (err) return;
            Quagga.start();
            escanerActivo = true;
            document.getElementById('btn-toggle').innerText = "üõë DETENER ESC√ÅNER";
            document.getElementById('btn-toggle').style.background = "#ff4d4d";
        });

        // FEEDBACK VISUAL DE ENFOQUE
        Quagga.onProcessed(result => {
            const ctx = Quagga.canvas.ctx.overlay;
            const canvas = Quagga.canvas.dom.overlay;
            if (result) {
                ctx.clearRect(0, 0, parseInt(canvas.width), parseInt(canvas.height));
                if (result.boxes) {
                    result.boxes.filter(b => b !== result.box).forEach(b => {
                        Quagga.ImageDebug.drawPath(b, { x: 0, y: 1 }, ctx, { color: "blue", lineWidth: 2 });
                    });
                }
                if (result.box) Quagga.ImageDebug.drawPath(result.box, { x: 0, y: 1 }, ctx, { color: "#39ff14", lineWidth: 2 });
            }
        });

        Quagga.onDetected(res => {
            const code = res.codeResult.code;
            if (codActual === code) return;
            codActual = code;
            playPi();
            if (navigator.vibrate) navigator.vibrate(100);
            abrirGestion(code);
        });
    }

    function abrirGestion(code) {
        Quagga.stop();
        document.getElementById('p-cantidad').value = 1;
        if (db[code]) {
            document.getElementById('form-nuevo').style.display = "none";
            document.getElementById('info-existente').style.display = "block";
            document.getElementById('txt-nombre').innerText = db[code].nombre;
            document.getElementById('txt-codigo').innerText = code;
        } else {
            document.getElementById('form-nuevo').style.display = "block";
            document.getElementById('info-existente').style.display = "none";
        }
        modalUI.show();
    }

    function guardar() {
        const cant = parseInt(document.getElementById('p-cantidad').value);
        if (db[codActual]) {
            db[codActual].stock += cant;
        } else {
            const nom = document.getElementById('p-nombre').value;
            if(!nom) return alert("Escribe un nombre");
            db[codActual] = { nombre: nom, medida: document.getElementById('p-medida').value, stock: cant };
        }
        localStorage.setItem('quagga_pro_db', JSON.stringify(db));
        actualizarLista();
        cerrarModal();
    }

    function actualizarLista() {
        const lista = document.getElementById('lista-productos');
        lista.innerHTML = "";
        Object.keys(db).reverse().forEach(id => {
            lista.innerHTML += `
                <div class="inventory-card d-flex justify-content-between align-items-center">
                    <div>
                        <div class="fw-bold">${db[id].nombre}</div>
                        <div class="text-muted small">${id}</div>
                    </div>
                    <div class="text-end">
                        <span class="h5 m-0 fw-bold">${db[id].stock}</span><br>
                        <small class="text-uppercase text-muted" style="font-size:0.6rem;">${db[id].medida}</small>
                    </div>
                </div>`;
        });
    }

    function cerrarModal() {
        modalUI.hide();
        document.getElementById('p-nombre').value = "";
        codActual = "";
        setTimeout(() => { if(escanerActivo) iniciarQuagga(); }, 500);
    }

    function ajustar(v) { document.getElementById('p-cantidad').value = parseInt(document.getElementById('p-cantidad').value) + v; }

    function exportarPDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        doc.setFontSize(18); doc.text("REPORTE DE ALMAC√âN", 14, 20);
        const data = Object.keys(db).map(k => [k, db[k].nombre, db[k].stock, db[k].medida]);
        doc.autoTable({ head: [['C√≥digo', 'Producto', 'Stock', 'Medida']], body: data, startY: 30 });
        doc.save("Inventario_Final.pdf");
    }

    actualizarLista();
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
