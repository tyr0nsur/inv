<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Inventario con Esc谩ner</title>

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- DataTables -->
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">

  <!-- FontAwesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

  <style>
    body { background:#f4f6f9; }
    #scanner video { width:100%; height:auto; }
    #scanner { width:100%; height:100%; }
  </style>
</head>
<body>

<nav class="navbar navbar-dark bg-dark">
  <div class="container-fluid">
    <span class="navbar-brand"> Inventario Almac茅n</span>
    <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#scannerModal">
      <i class="fa fa-barcode"></i> Escanear
    </button>
  </div>
</nav>

<div class="container mt-4">
  <div class="d-flex justify-content-between mb-3">
    <h5>Inventario</h5>
    <button class="btn btn-danger" onclick="exportPDF()">
      <i class="fa fa-file-pdf"></i> Exportar PDF
    </button>
  </div>

  <table id="inventoryTable" class="table table-striped table-bordered w-100">
    <thead>
      <tr>
        <th>C贸digo</th>
        <th>Producto</th>
        <th>Cantidad</th>
        <th>Ubicaci贸n</th>
        <th>Acciones</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<!-- MODAL ESCNER -->
<div class="modal fade" id="scannerModal" tabindex="-1">
  <div class="modal-dialog modal-fullscreen">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Escanear c贸digo</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body p-0">
        <div id="scanner"></div>
      </div>
    </div>
  </div>
</div>

<!-- MODAL PRODUCTO -->
<div class="modal fade" id="productModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Producto</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="prodCode">
        <div class="mb-2">
          <label>Nombre</label>
          <input class="form-control" id="prodName">
        </div>
        <div class="mb-2">
          <label>Cantidad</label>
          <input type="number" class="form-control" id="prodQty" value="1">
        </div>
        <div class="mb-2">
          <label>Ubicaci贸n</label>
          <input class="form-control" id="prodLoc">
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-primary" onclick="saveProduct()">Guardar</button>
      </div>
    </div>
  </div>
</div>

<!-- LIBS (ORDEN CORRECTO) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
<script src="https://unpkg.com/@ericblade/quagga2/dist/quagga.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>

<script>
let inventory = JSON.parse(localStorage.getItem('inventory') || '[]');
let table;
let scannerActive = false;

$(document).ready(() => {
  table = $('#inventoryTable').DataTable({ responsive:true });
  renderTable();
});

function renderTable(){
  table.clear();
  inventory.forEach(p => {
    table.row.add([
      p.code,
      p.name,
      p.qty,
      p.loc,
      `<button class='btn btn-sm btn-warning' onclick='editProduct("${p.code}")'><i class='fa fa-edit'></i></button>`
    ]);
  });
  table.draw();
  localStorage.setItem('inventory', JSON.stringify(inventory));
}

function startScanner(){
  if(scannerActive) return;
  scannerActive = true;

  Quagga.init({
    inputStream:{
      type:'LiveStream',
      target:document.querySelector('#scanner'),
      constraints:{
        facingMode:'environment',
        width:{ideal:1280},
        height:{ideal:720}
      }
    },
    locator:{ patchSize:'medium', halfSample:false },
    numOfWorkers:navigator.hardwareConcurrency || 4,
    decoder:{ readers:['ean_reader','ean_8_reader','code_128_reader','upc_reader'] },
    locate:true
  }, err => {
    if(err){ console.error(err); return; }
    Quagga.start();
  });

  Quagga.offDetected();
  Quagga.onDetected(res => {
    const code = res.codeResult.code;
    navigator.vibrate(200);
    stopScanner();
    bootstrap.Modal.getInstance(scannerModal).hide();
    openProductModal(code);
  });
}

function stopScanner(){
  scannerActive = false;
  Quagga.stop();
}

scannerModal.addEventListener('shown.bs.modal', startScanner);
scannerModal.addEventListener('hidden.bs.modal', stopScanner);

function openProductModal(code){
  const p = inventory.find(i => i.code === code);
  prodCode.value = code;
  prodName.value = p?.name || '';
  prodQty.value = p?.qty || 1;
  prodLoc.value = p?.loc || '';
  new bootstrap.Modal(productModal).show();
}

function saveProduct(){
  const code = prodCode.value;
  let p = inventory.find(i => i.code === code);
  if(p){
    p.name = prodName.value;
    p.qty = prodQty.value;
    p.loc = prodLoc.value;
  } else {
    inventory.push({ code, name:prodName.value, qty:prodQty.value, loc:prodLoc.value });
  }
  renderTable();
  bootstrap.Modal.getInstance(productModal).hide();
}

function editProduct(code){ openProductModal(code); }

function exportPDF(){
  const doc = new jspdf.jsPDF();
  doc.text('Inventario de Almac茅n',14,15);
  doc.autoTable({
    head:[['C贸digo','Producto','Cantidad','Ubicaci贸n']],
    body:inventory.map(p=>[p.code,p.name,p.qty,p.loc])
  });
  doc.save('inventario.pdf');
}
</script>
</body>
</html>
