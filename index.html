<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Inventario PRO Â· ZXing</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />

  <!-- ZXing WASM -->
  <script src="https://unpkg.com/@zxing/library@0.21.0"></script>
</head>
<body class="bg-slate-100 text-slate-800">

<!-- HEADER -->
<header class="bg-black text-white px-4 py-3 flex justify-between items-center">
  <h1 class="text-lg font-semibold">ðŸ“¦ Inventario PRO</h1>
  <button onclick="openScanner()" class="bg-emerald-500 px-4 py-2 rounded-lg font-medium">
    <i class="fa fa-barcode"></i>
  </button>
</header>

<!-- CONTENT -->
<main class="p-4 space-y-4">
  <div class="flex justify-between items-center">
    <h2 class="font-semibold">Inventario</h2>
    <button onclick="exportPDF()" class="text-sm bg-red-500 text-white px-3 py-2 rounded-lg">
      <i class="fa fa-file-pdf"></i> PDF
    </button>
  </div>

  <div class="overflow-x-auto bg-white rounded-xl shadow">
    <table class="min-w-full text-sm">
      <thead class="bg-slate-200">
        <tr>
          <th class="px-3 py-2 text-left">CÃ³digo</th>
          <th class="px-3 py-2">Producto</th>
          <th class="px-3 py-2">Qty</th>
          <th class="px-3 py-2">UbicaciÃ³n</th>
        </tr>
      </thead>
      <tbody id="inventoryTable"></tbody>
    </table>
  </div>
</main>

<!-- SCANNER MODAL -->
<div id="scannerModal" class="fixed inset-0 bg-black/90 hidden z-50">
  <div class="absolute top-4 right-4">
    <button onclick="closeScanner()" class="text-white text-2xl">âœ•</button>
  </div>
  <video id="video" class="w-full h-full object-cover"></video>
</div>

<!-- PRODUCT MODAL -->
<div id="productModal" class="fixed inset-0 bg-black/50 hidden z-40 flex items-center justify-center">
  <div class="bg-white rounded-xl w-11/12 max-w-sm p-4 space-y-3">
    <h3 class="font-semibold">Producto</h3>
    <input id="prodCode" type="hidden" />
    <input id="prodName" placeholder="Nombre" class="w-full border p-2 rounded" />
    <input id="prodQty" type="number" value="1" class="w-full border p-2 rounded" />
    <input id="prodLoc" placeholder="UbicaciÃ³n" class="w-full border p-2 rounded" />
    <button onclick="saveProduct()" class="w-full bg-emerald-500 text-white py-2 rounded">Guardar</button>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>

<script>
let inventory = JSON.parse(localStorage.getItem('inventory') || '[]');
let codeReader;

function render(){
  const tbody = document.getElementById('inventoryTable');
  tbody.innerHTML = '';
  inventory.forEach(p => {
    tbody.innerHTML += `
      <tr class="border-t">
        <td class="px-3 py-2">${p.code}</td>
        <td class="px-3 py-2">${p.name}</td>
        <td class="px-3 py-2 text-center">${p.qty}</td>
        <td class="px-3 py-2">${p.loc}</td>
      </tr>`;
  });
  localStorage.setItem('inventory', JSON.stringify(inventory));
}
render();

async function openScanner(){
  document.getElementById('scannerModal').classList.remove('hidden');
  codeReader = new ZXing.BrowserMultiFormatReader();
  const devices = await ZXing.BrowserCodeReader.listVideoInputDevices();
  const backCam = devices.find(d => d.label.toLowerCase().includes('back')) || devices[0];

  codeReader.decodeFromVideoDevice(backCam.deviceId, 'video', (res, err) => {
    if(res){
      navigator.vibrate?.(200);
      closeScanner();
      openProduct(res.text);
    }
  });
}

function closeScanner(){
  document.getElementById('scannerModal').classList.add('hidden');
  if(codeReader) codeReader.reset();
}

function openProduct(code){
  const p = inventory.find(i => i.code === code);
  prodCode.value = code;
  prodName.value = p?.name || '';
  prodQty.value = p?.qty || 1;
  prodLoc.value = p?.loc || '';
  productModal.classList.remove('hidden');
}

function saveProduct(){
  const code = prodCode.value;
  let p = inventory.find(i => i.code === code);
  if(p){ p.name=prodName.value; p.qty=prodQty.value; p.loc=prodLoc.value; }
  else inventory.push({code,name:prodName.value,qty:prodQty.value,loc:prodLoc.value});
  productModal.classList.add('hidden');
  render();
}

function exportPDF(){
  const doc = new jspdf.jsPDF();
  doc.text('Inventario PRO',14,15);
  doc.autoTable({ head:[['CÃ³digo','Producto','Cantidad','UbicaciÃ³n']], body:inventory.map(p=>[p.code,p.name,p.qty,p.loc]) });
  doc.save('inventario.pdf');
}
</script>
</body>
</html>
