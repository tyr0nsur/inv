<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Inventario Omnidireccional V7</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <style>
        body { background-color: #000; color: white; font-family: sans-serif; overflow-x: hidden; }
        #video-container { position: relative; width: 100vw; height: 60vh; background: #000; }
        video { width: 100%; height: 100%; object-fit: cover; }
        
        /* El "Target" de escaneo */
        .scanner-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            border: 40px solid rgba(0,0,0,0.5);
            pointer-events: none; box-sizing: border-box;
        }
        .scanner-box {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 80%; height: 60%; border: 2px solid #00ff00; border-radius: 20px;
            box-shadow: 0 0 20px rgba(0,255,0,0.5);
        }
        .scan-anim {
            position: absolute; top: 0; left: 0; width: 100%; height: 4px;
            background: #00ff00; opacity: 0.5; animation: moving 2s infinite;
        }
        @keyframes moving { 0% { top: 0; } 50% { top: 100%; } 100% { top: 0; } }

        .panel-datos {
            background: white; color: #333; border-radius: 30px 30px 0 0;
            padding: 20px; min-height: 40vh; position: relative; z-index: 100;
        }
        .product-card { background: #f8f9fa; border-radius: 15px; padding: 15px; margin-bottom: 10px; border: 1px solid #eee; }
    </style>
</head>
<body>

<div id="video-container">
    <video id="webcam" autoplay playsinline muted></video>
    <div class="scanner-overlay">
        <div class="scanner-box">
            <div class="scan-anim"></div>
        </div>
    </div>
</div>

<div class="panel-datos">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h4 class="fw-bold m-0 text-primary">Inventario Activo</h4>
        <button class="btn btn-sm btn-danger rounded-pill" onclick="exportarPDF()">PDF</button>
    </div>

    <div id="lista-db" style="max-height: 30vh; overflow-y: auto;">
        </div>
</div>

<div class="modal fade" id="modalConfirm" data-bs-backdrop="static" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg text-dark">
            <div class="modal-body p-4">
                <div id="view-nuevo" style="display:none;">
                    <h5 class="text-primary fw-bold">Nuevo Producto</h5>
                    <input type="text" id="in-nombre" class="form-control mb-3" placeholder="Nombre (ej: Refresco 500ml)">
                    <select id="in-medida" class="form-select mb-3">
                        <option value="Unidades">Unidades</option>
                        <option value="Litros">Litros</option>
                        <option value="Cajas">Cajas</option>
                    </select>
                </div>
                <div id="view-existente" class="text-center">
                    <h3 id="txt-nombre" class="fw-bold"></h3>
                    <p id="txt-stock" class="text-muted small"></p>
                </div>
                <div class="input-group input-group-lg my-3">
                    <button class="btn btn-light border" onclick="step(-1)">-</button>
                    <input type="number" id="in-cant" class="form-control text-center" value="1">
                    <button class="btn btn-light border" onclick="step(1)">+</button>
                </div>
                <button class="btn btn-primary w-100 py-3 fw-bold rounded-3" onclick="confirmar()">GUARDAR</button>
                <button class="btn btn-link w-100 text-muted mt-2" onclick="cancelar()">Ignorar</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    let db = JSON.parse(localStorage.getItem('inv_v7')) || {};
    let codActual = "";
    let scanning = true;
    const modal = new bootstrap.Modal(document.getElementById('modalConfirm'));
    const video = document.getElementById('webcam');

    // 1. INICIAR CÁMARA
    async function setupCamera() {
        const stream = await navigator.mediaDevices.getUserMedia({ 
            video: { facingMode: "environment", focusMode: "continuous", width: { ideal: 1280 }, height: { ideal: 720 } } 
        });
        video.srcObject = stream;
    }

    // 2. MOTOR DE DETECCIÓN INTELIGENTE
    async function startScanning() {
        if (!('BarcodeDetector' in window)) {
            alert("Tu navegador no soporta escaneo nativo. Usa Chrome en Android o Safari en iOS actualizado.");
            return;
        }

        const detector = new BarcodeDetector({ formats: ['ean_13', 'ean_8', 'code_128', 'upc_a'] });

        async function render() {
            if (scanning && video.readyState === video.HAVE_ENOUGH_DATA) {
                try {
                    const barcodes = await detector.detect(video);
                    if (barcodes.length > 0) {
                        const code = barcodes[0].rawValue;
                        vibrar();
                        abrirModal(code);
                    }
                } catch (e) { console.error(e); }
            }
            requestAnimationFrame(render);
        }
        render();
    }

    function abrirModal(code) {
        scanning = false;
        codActual = code;
        document.getElementById('in-cant').value = 1;

        if (db[code]) {
            document.getElementById('view-nuevo').style.display = "none";
            document.getElementById('view-existente').style.display = "block";
            document.getElementById('txt-nombre').innerText = db[code].nombre;
            document.getElementById('txt-stock').innerText = `En stock: ${db[code].stock} ${db[code].medida}`;
        } else {
            document.getElementById('view-nuevo').style.display = "block";
            document.getElementById('view-existente').style.display = "none";
        }
        modal.show();
    }

    function confirmar() {
        const c = parseInt(document.getElementById('in-cant').value);
        if (db[codActual]) {
            db[codActual].stock += c;
        } else {
            const n = document.getElementById('in-nombre').value;
            if(!n) return alert("Ponle un nombre");
            db[codActual] = { nombre: n, medida: document.getElementById('in-medida').value, stock: c };
        }
        localStorage.setItem('inv_v7', JSON.stringify(db));
        actualizarUI();
        cancelar();
    }

    function cancelar() {
        modal.hide();
        document.getElementById('in-nombre').value = "";
        setTimeout(() => { scanning = true; codActual = ""; }, 500);
    }

    function step(v) { document.getElementById('in-cant').value = parseInt(document.getElementById('in-cant').value) + v; }
    function vibrar() { if(navigator.vibrate) navigator.vibrate(100); }

    function actualizarUI() {
        const list = document.getElementById('lista-db');
        list.innerHTML = "";
        Object.keys(db).reverse().forEach(k => {
            list.innerHTML += `
                <div class="product-card d-flex justify-content-between align-items-center">
                    <div>
                        <div class="fw-bold">${db[k].nombre}</div>
                        <div class="text-muted small">${k}</div>
                    </div>
                    <div class="text-end">
                        <span class="badge bg-primary fs-6">${db[k].stock}</span>
                    </div>
                </div>`;
        });
    }

    function exportarPDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        doc.text("INVENTARIO PROFESIONAL", 14, 15);
        const data = Object.keys(db).map(k => [k, db[k].nombre, db[k].stock, db[k].medida]);
        doc.autoTable({ head: [['Código', 'Producto', 'Stock', 'Medida']], body: data, startY: 20 });
        doc.save("Inventario.pdf");
    }

    setupCamera().then(startScanning);
    actualizarUI();
</script>
</body>
</html>
